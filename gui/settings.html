<!DOCTYPE html>
<html>

<head>
    <meta charset="UTF-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <title>QuickSay Settings</title>
    <link rel="stylesheet" href="settings.css">
    <style>
        /* CRITICAL INLINE STYLES TO FORCE RENDERING */
        body {
            margin: 0;
            padding: 0;
            color: #333333;
            overflow: hidden;
            display: block;
            position: fixed;
            width: 100%;
            height: 100%;
            background: #f0f2f5;
            /* Ensure background is defined */
        }

        .main-content {
            z-index: 50;
            /* Ensure above body */
        }

        /* Ensure dict-container is visible */
        .dict-container {
            border: 1.5px solid #e8e8e8;
            border-radius: 12px;
            max-height: 400px;
            overflow-y: auto;
            background: #fafbfc;
        }
    </style>
</head>

<body>

    <!-- SIDEBAR -->
    <div class="sidebar">
        <div class="logo">
            <img src="assets/logo_128.png" alt="QuickSay" style="width: 80px; height: 80px;">
            <span>QuickSay</span>
        </div>
        <button class="tab-btn active" data-tab="general">‚öôÔ∏è General</button>
        <button class="tab-btn" data-tab="audio">üé§ Audio</button>
        <button class="tab-btn" data-tab="dictionary">üìñ Dictionary</button>
        <button class="tab-btn" data-tab="advanced">üîß Advanced</button>
        <button class="tab-btn" data-tab="view-history">üìù History</button>
        <button class="tab-btn" data-tab="view-statistics">üìä Statistics</button>
    </div>

    <!-- MAIN CONTENT -->
    <div class="main-content">

        <!-- GENERAL TAB -->
        <div id="general" class="tab-content active">
            <h2>General Settings</h2>

            <div class="section">
                <h3>API Configuration</h3>
                <label>Groq API Key <a href="#" onclick="postToAHK('openUrl', 'https://console.groq.com/keys'); return false;" style="font-size: 12px; color: #888; text-decoration: none; margin-left: 8px;">Click here to get one</a></label>
                <div style="display: flex; gap: 10px; align-items: center;">
                    <div class="password-wrapper" style="flex: 1; min-width: 0;">
                        <input type="password" id="groqApiKey" placeholder="gsk_..." style="font-size: 13px;">
                        <span class="toggle-password" id="btnTogglePass">üëÅÔ∏è</span>
                    </div>
                    <button class="btn btn-primary btn-sm" id="btnTestApi" style="white-space: nowrap; flex-shrink: 0;">Test</button>
                </div>
                <div class="status-text" id="apiStatusMessage"></div>
            </div>

            <div class="section">
                <h3>Hotkey</h3>
                <div class="hotkey-options">
                    <!-- Default Option -->
                    <div class="toggle-item">
                        <label class="toggle-switch">
                            <input type="checkbox" class="hotkey-toggle" value="default" id="hkDefault">
                            <span class="toggle-slider"></span>
                        </label>
                        <label for="hkDefault" style="cursor: pointer;">
                            <div style="font-weight: 500; color: #333; display: flex; align-items: center;">
                                Ctrl + Win
                                <span class="badge"
                                    style="margin-left: 8px; font-size: 10px; padding: 1px 6px; vertical-align: middle;">RECOMMENDED</span>
                            </div>
                            <span class="sub-text">Recommended for seamless system-wide access</span>
                        </label>
                    </div>

                    <!-- Custom Option -->
                    <div class="toggle-item">
                        <label class="toggle-switch">
                            <input type="checkbox" class="hotkey-toggle" value="custom" id="hkCustom">
                            <span class="toggle-slider"></span>
                        </label>
                        <label for="hkCustom" style="cursor: pointer;">
                            <div style="font-weight: 500; color: #333;">Custom</div>
                            <span class="sub-text">Set your own hotkey combination</span>
                        </label>
                    </div>

                    <!-- Custom Controls -->
                    <div id="customHotkeyControls" style="display: none; margin-left: 58px; margin-top: -4px;">
                        <div class="hotkey-display">
                            <input type="text" id="hotkeyDisplay" readonly placeholder="No hotkey set"
                                style="width: 240px; margin-right: 10px;">
                            <button class="btn btn-secondary-orange" id="btnChangeHotkey"
                                style="white-space: nowrap; padding: 10px 20px;">Change</button>
                        </div>
                    </div>
                </div>

                <!-- Sticky Mode -->
                <div class="toggle-item" style="margin-top: 18px;">
                    <label class="toggle-switch">
                        <input type="checkbox" id="stickyMode">
                        <span class="toggle-slider"></span>
                    </label>
                    <label for="stickyMode">
                        <div style="font-weight: 500; color: #333;">Sticky Mode</div>
                        <span class="sub-text">Tap hotkey to start, tap again to stop (instead of hold)</span>
                    </label>
                </div>
            </div>

            <div class="section">
                <h3>Preferences</h3>
                <div style="display: flex; flex-direction: column; gap: 14px;">
                    <div class="toggle-item">
                        <label class="toggle-switch">
                            <input type="checkbox" id="launchAtStartup">
                            <span class="toggle-slider"></span>
                        </label>
                        <label for="launchAtStartup">Launch at Windows startup</label>
                    </div>

                    <div class="toggle-item">
                        <label class="toggle-switch">
                            <input type="checkbox" id="showOverlay">
                            <span class="toggle-slider"></span>
                        </label>
                        <label for="showOverlay">Show overlay during recording</label>
                    </div>

                    <div class="toggle-item">
                        <label class="toggle-switch">
                            <input type="checkbox" id="playSounds">
                            <span class="toggle-slider"></span>
                        </label>
                        <label for="playSounds">Play sound on start/stop</label>
                    </div>
                </div>
            </div>
        </div>

        <!-- AUDIO TAB -->
        <div id="audio" class="tab-content">
            <h2>Audio Settings</h2>
            <div class="section">
                <h3>Device Selection</h3>
                <label>Microphone Device</label>
                <div style="display: flex; gap: 14px; align-items: center;">
                    <select id="audioDevice" style="flex: 1;">
                        <option value="Default">Default - System Device</option>
                    </select>
                    <button class="btn btn-secondary-orange" id="btnRefreshAudio"
                        style="white-space: nowrap; padding: 10px 20px;">Refresh</button>
                </div>
            </div>

            <div class="section">
                <h3>Recording Quality</h3>
                <div style="display: flex; flex-direction: column; gap: 14px;">
                    <div class="toggle-item">
                        <label class="toggle-switch">
                            <input type="checkbox" class="quality-toggle" data-quality="high" id="qualityHigh">
                            <span class="toggle-slider"></span>
                        </label>
                        <label for="qualityHigh">
                            <div style="font-weight: 500; color: #333;">High (44.1kHz)</div>
                            <span class="sub-text">~10MB/min</span>
                        </label>
                    </div>

                    <div class="toggle-item">
                        <label class="toggle-switch">
                            <input type="checkbox" class="quality-toggle" data-quality="medium" id="qualityMedium">
                            <span class="toggle-slider"></span>
                        </label>
                        <label for="qualityMedium">
                            <div style="font-weight: 500; color: #333;">Medium (22kHz)</div>
                            <span class="sub-text">~5MB/min - Recommended</span>
                        </label>
                    </div>

                    <div class="toggle-item">
                        <label class="toggle-switch">
                            <input type="checkbox" class="quality-toggle" data-quality="low" id="qualityLow">
                            <span class="toggle-slider"></span>
                        </label>
                        <label for="qualityLow">
                            <div style="font-weight: 500; color: #333;">Low (16kHz)</div>
                            <span class="sub-text">~3MB/min</span>
                        </label>
                    </div>
                </div>
            </div>

            <div class="section">
                <h3>Storage</h3>
                <div class="toggle-item">
                    <label class="toggle-switch">
                        <input type="checkbox" id="saveAudioRecordings">
                        <span class="toggle-slider"></span>
                    </label>
                    <label for="saveAudioRecordings">Save audio recordings (debug)</label>
                </div>
                <div style="margin-top: 18px; display: flex; align-items: center; gap: 12px;">
                    <span style="font-size: 14px; color: #666;">Keep last:</span>
                    <select style="width: 90px;" id="keepLastRecordings">
                        <option value="10">10</option>
                        <option value="50">50</option>
                        <option value="100">100</option>
                    </select>
                    <span style="font-size: 14px; color: #666;">recordings</span>
                </div>
            </div>
        </div>

        <!-- DICTIONARY TAB -->
        <div id="dictionary" class="tab-content">
            <h2>Custom Dictionary</h2>
            <div class="search-wrapper">
                <span class="search-icon">üîç</span>
                <input type="text" class="search-input" placeholder="Search terms..." id="dictSearch">
            </div>
            <div class="dict-container" id="dictList"></div>
            <div style="margin-top: 20px; display: flex; gap: 12px;">
                <button class="btn btn-primary" id="btnAddEntryModal">+ Add Entry</button>
                <button class="btn btn-secondary-orange" id="btnImportDict">Import</button>
                <button class="btn btn-secondary-orange" id="btnExportDict">Export</button>
            </div>
        </div>

        <!-- ADVANCED TAB -->
        <div id="advanced" class="tab-content">
            <h2>Advanced Settings</h2>
            <div class="section">
                <h3>Text Processing</h3>
                <div style="display: flex; flex-direction: column; gap: 14px;">
                    <div class="toggle-item">
                        <label class="toggle-switch">
                            <input type="checkbox" id="enableLLMCleanup">
                            <span class="toggle-slider"></span>
                        </label>
                        <label for="enableLLMCleanup">Enable LLM cleanup</label>
                    </div>

                    <div class="toggle-item">
                        <label class="toggle-switch">
                            <input type="checkbox" id="autoRemoveFillers">
                            <span class="toggle-slider"></span>
                        </label>
                        <label for="autoRemoveFillers">Auto-remove fillers (um, uh)</label>
                    </div>

                    <div class="toggle-item">
                        <label class="toggle-switch">
                            <input type="checkbox" id="smartPunctuation">
                            <span class="toggle-slider"></span>
                        </label>
                        <label for="smartPunctuation">Smart punctuation</label>
                    </div>
                </div>
            </div>

            <div class="section">
                <h3>History</h3>
                <label>Retention Limit</label>
                <div style="display: flex; gap: 14px; align-items: center;">
                    <select id="historyRetention" style="width:160px;">
                        <option value="100">100 entries</option>
                        <option value="500">500 entries</option>
                        <option value="0">Unlimited</option>
                    </select>
                    <button class="btn btn-danger" id="btnClearHistory">Clear History</button>
                </div>
                <div class="sub-text" id="historyCountDisplay" style="margin-top:12px">Loading...</div>
            </div>

            <div class="section">
                <h3>Debug</h3>
                <div class="toggle-item">
                    <label class="toggle-switch">
                        <input type="checkbox" id="debugLogging">
                        <span class="toggle-slider"></span>
                    </label>
                    <label for="debugLogging">Enable debug logging</label>
                </div>
                <button class="btn btn-secondary" id="btnViewLogs" style="margin-top:16px">View Logs Folder</button>
            </div>


        </div>

        <!-- HISTORY TAB -->
        <div id="view-history" class="tab-content">
            <h2>Transcription History</h2>
            <div class="search-wrapper">
                <span class="search-icon">üîç</span>
                <input type="text" class="search-input" placeholder="Search history..." id="historySearch"
                    onkeyup="searchHistory()">
            </div>
            <div class="dict-container" id="historyList"></div>
            <div style="margin-top: 20px; display: flex; gap: 12px;">
                <span id="historyTabCount"
                    style="margin-right: auto; color: #888; align-self: center; font-size: 13px;"></span>
                <button class="btn btn-secondary-orange" id="btnRefreshHistory">Refresh</button>
                <button class="btn btn-danger" id="btnClearFullHistory">Clear All</button>
            </div>
        </div>

        <!-- STATISTICS TAB -->
        <div id="view-statistics" class="tab-content">
            <h2>Usage Statistics</h2>

            <!-- KPI Cards -->
            <div class="section" style="padding: 0; overflow: hidden;">
                <h3 style="padding: 28px 28px 0 28px;">Overview</h3>
                <div style="display: grid; grid-template-columns: repeat(3, 1fr); gap: 0;">
                    <div style="padding: 20px; text-align: center; border-right: 1px solid rgba(0,0,0,0.06);">
                        <div style="font-size: 28px; margin-bottom: 8px;">üí¨</div>
                        <div style="font-size: 24px; font-weight: 700; color: #FF6B35;" id="statTotalWords">0</div>
                        <div style="font-size: 11px; color: #888; text-transform: uppercase; letter-spacing: 0.5px;">Total Words</div>
                    </div>
                    <div style="padding: 20px; text-align: center; border-right: 1px solid rgba(0,0,0,0.06);">
                        <div style="font-size: 28px; margin-bottom: 8px;">‚ö°</div>
                        <div style="font-size: 24px; font-weight: 700; color: #FF6B35;" id="statWPM">0</div>
                        <div style="font-size: 11px; color: #888; text-transform: uppercase; letter-spacing: 0.5px;">Avg WPM</div>
                    </div>
                    <div style="padding: 20px; text-align: center;">
                        <div style="font-size: 28px; margin-bottom: 8px;">üî•</div>
                        <div style="font-size: 24px; font-weight: 700; color: #FF6B35;" id="statStreak">0</div>
                        <div style="font-size: 11px; color: #888; text-transform: uppercase; letter-spacing: 0.5px;">Day Streak</div>
                    </div>
                </div>
            </div>

            <!-- Achievements -->
            <div class="section">
                <h3>Achievements</h3>
                <div id="achievementsList" style="display: flex; flex-direction: column; gap: 12px;"></div>
            </div>
        </div>
    </div> <!-- closes .main-content -->

    <!-- FOOTER -->
    <div class="footer">
        <button class="btn btn-secondary" id="btnCancel">Cancel</button>
        <button class="btn btn-secondary-orange" id="btnApply">Apply</button>
        <button class="btn btn-primary" id="btnSave">Save</button>
    </div>

    <!-- MODALS -->

    <!-- Hotkey Modal -->
    <div class="modal-overlay" id="modalHotkey">
        <div class="modal">
            <h3>Change Hotkey</h3>
            <p style="color: #666; margin-bottom: 12px;">Press your desired key combination now...</p>
            <p style="color: #999; font-size: 12px; margin-bottom: 20px;">Hold modifiers (Ctrl, Alt, Shift) + press a key (e.g. Ctrl+Alt+Space). Modifier-only combos are not supported.</p>
            <div class="display-box" id="newHotkeyDisplay"
                style="height: 60px; line-height:40px; margin-bottom: 24px; font-size: 16px;">Listening...</div>
            <div class="modal-actions">
                <button class="btn btn-secondary" id="btnCancelHotkey">Cancel</button>
                <button class="btn btn-primary" id="btnConfirmHotkey">Set Hotkey</button>
            </div>
        </div>
    </div>

    <!-- Add Entry Modal -->
    <div class="modal-overlay" id="modalAddEntry">
        <div class="modal">
            <h3>Add Dictionary Entry</h3>
            <label>Spoken (what you say)</label>
            <input type="text" id="entrySpoken" placeholder="e.g. kubernetes" style="margin-bottom:16px;">
            <label>Written (what appears)</label>
            <input type="text" id="entryWritten" placeholder="e.g. Kubernetes" style="margin-bottom:16px;">
            <div class="modal-actions">
                <button class="btn btn-secondary" id="btnCancelEntry">Cancel</button>
                <button class="btn btn-primary" id="btnSaveEntry">Add Entry</button>
            </div>
        </div>
    </div>

    <!-- Toast -->
    <div class="toast" id="toastMessage">Settings Saved!</div>

    <!-- Modals -->
    <div id="customModal"
        style="display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0, 0, 0, 0.85); z-index: 999999; align-items: center; justify-content: center;">
        <div
            style="background: #ffffff; border-radius: 12px; width: 480px; box-shadow: 0 25px 60px rgba(0, 0, 0, 0.8); overflow: hidden;">
            <div style="padding: 24px 28px; background: #f8f9fa; border-bottom: 2px solid #e0e0e0;">
                <h3 id="modalTitle" style="margin: 0; font-size: 19px; font-weight: 700; color: #212529;">Title</h3>
            </div>
            <div style="padding: 32px 28px; background: #ffffff;">
                <p id="modalMessage"
                    style="margin: 0; font-size: 16px; line-height: 1.5; color: #212529; font-weight: 500;">Message</p>
            </div>
            <div id="modalButtons"
                style="padding: 20px 28px; background: #f8f9fa; border-top: 2px solid #e0e0e0; display: flex; justify-content: flex-end; gap: 12px;">
                <!-- Buttons inserted by JavaScript -->
            </div>
        </div>
    </div>

    <script>
        // --- ES5 COMPATIBLE SCRIPT --- 

        // Globals (using var)
        var config = {};
        var dictionary = [];
        var tempHotkey = "";

        // ==================================================================
        // WebView2 Message Handler - Receive messages from AHK
        // ==================================================================
        if (window.chrome && window.chrome.webview) {
            window.chrome.webview.addEventListener('message', function (event) {
                console.log('=== MESSAGE RECEIVED FROM AHK ===');
                console.log('Raw event.data:', event.data);

                try {
                    // Parse the message if it's a string
                    const msg = typeof event.data === 'string' ? JSON.parse(event.data) : event.data;

                    console.log('Parsed message:', msg);
                    console.log('Function to call:', msg.function);
                    console.log('Data to pass:', msg.data);

                    const functionName = msg.function;
                    const data = msg.data;

                    // Call the appropriate JavaScript function
                    if (window[functionName] && typeof window[functionName] === 'function') {
                        console.log('Calling function:', functionName);
                        window[functionName](data);
                    } else {
                        console.error('Function not found or not callable:', functionName);
                    }
                } catch (err) {
                    console.error('Error handling WebView2 message:', err);
                    console.error('Event data was:', event.data);
                }
            });

            console.log('WebView2 message listener registered successfully');
        }

        // --- INIT ---
        window.onload = function () {
            // Setup Tabs
            var tabs = document.querySelectorAll('.tab-btn');
            for (var i = 0; i < tabs.length; i++) {
                tabs[i].onclick = function () { switchTab(this); };
            }

            // Quality Toggle Mutual Exclusivity
            var qualityToggles = document.querySelectorAll('.quality-toggle');
            for (var i = 0; i < qualityToggles.length; i++) {
                qualityToggles[i].onclick = function () {
                    var selectedQuality = this.getAttribute('data-quality');
                    var allToggles = document.querySelectorAll('.quality-toggle');
                    for (var j = 0; j < allToggles.length; j++) {
                        allToggles[j].checked = false;
                    }
                    this.checked = true;
                    config.recordingQuality = selectedQuality;
                };
            }

            // Buttons
            document.getElementById('btnSave').onclick = function () { saveConfig(true); };
            document.getElementById('btnApply').onclick = function () { saveConfig(false); };
            document.getElementById('btnCancel').onclick = closeSettings;

            document.getElementById('btnTestApi').onclick = testApiConnection;
            document.getElementById('btnTogglePass').onclick = togglePass;

            document.getElementById('btnChangeHotkey').onclick = function () { openModal('modalHotkey'); startHotkeyListen(); };
            document.getElementById('btnCancelHotkey').onclick = function () { closeModal('modalHotkey'); stopHotkeyListen(); };
            document.getElementById('btnConfirmHotkey').onclick = confirmHotkey;

            document.getElementById('btnRefreshAudio').onclick = function () { postToAHK('getAudioDevices'); };

            // Dictionary Buttons
            document.getElementById('btnAddEntryModal').onclick = function () {
                document.getElementById('entrySpoken').value = "";
                document.getElementById('entryWritten').value = "";
                openModal('modalAddEntry');
            };
            document.getElementById('btnCancelEntry').onclick = function () { closeModal('modalAddEntry'); };
            document.getElementById('btnSaveEntry').onclick = addDictionaryEntry;

            document.getElementById('btnImportDict').onclick = function () { postToAHK('importDictionary'); };
            document.getElementById('btnExportDict').onclick = function () { postToAHK('exportDictionary'); };
            document.getElementById('dictSearch').onkeyup = renderDictionary; // Search filter

            // Advanced
            document.getElementById('btnClearHistory').onclick = clearHistory;
            document.getElementById('btnViewLogs').onclick = function () { postToAHK('viewLogs'); };

            // History Tab Buttons
            document.getElementById('btnRefreshHistory').onclick = function () {
                console.log('Refresh History button clicked');
                loadHistory();
            };

            document.getElementById('btnClearFullHistory').onclick = function () {
                if (confirm('This will permanently delete all transcription history. Clear all history?')) {
                    console.log('User confirmed - clearing full history');
                    postToAHK('deleteHistoryFile');

                    // Reload history after clearing
                    setTimeout(function () {
                        loadHistory();
                    }, 500);
                }
            };

            // History search
            document.getElementById('historySearch').onkeyup = searchHistory;

            // Start Load
            postToAHK('loadConfig');

            // Initial Tab
            switchTab(document.querySelector('.tab-btn[data-tab="general"]'));

            // Initial data load after everything is ready
            console.log("‚ïê‚ïê‚ïê INITIALIZATION COMPLETE ‚ïê‚ïê‚ïê");
            console.log("WebView2 available?", !!window.chrome && !!window.chrome.webview);

            // Give WebView2 time to fully initialize
            setTimeout(function () {
                console.log("‚ïê‚ïê‚ïê ATTEMPTING INITIAL DATA LOAD ‚ïê‚ïê‚ïê");
                loadHistory();
                loadStatistics();
            }, 1000);
        };

        // --- TABS ---
        function switchTab(btn) {
            var tabId = btn.getAttribute('data-tab');

            // Buttons
            var allBtns = document.querySelectorAll('.tab-btn');
            for (var i = 0; i < allBtns.length; i++) allBtns[i].className = 'tab-btn';
            btn.className = 'tab-btn active';

            // Content
            var allContent = document.querySelectorAll('.tab-content');
            for (var i = 0; i < allContent.length; i++) allContent[i].className = 'tab-content';
            document.getElementById(tabId).className = 'tab-content active';

            // Lazy Load
            if (tabId === 'audio') postToAHK('getAudioDevices');

            if (tabId === 'dictionary') {
                postToAHK('loadDictionary');
                setTimeout(function () {
                    if (dictionary.length === 0) {
                        var list = document.getElementById('dictList');
                        list.innerHTML = '<div style="text-align:center; padding:40px; color:#999;">No dictionary entries yet.<br><br><strong>Click "+ Add Entry"</strong> to create your first custom term.</div>';
                    }
                }, 1000);
            }

            if (tabId === 'advanced') postToAHK('getHistoryCount');

            // Load History & Statistics data when switching to those tabs
            if (tabId === 'view-history') {
                console.log('Switching to History tab - loading data...');
                loadHistory();
            }

            if (tabId === 'view-statistics') {
                console.log('Switching to Statistics tab - loading data...');
                loadStatistics();
            }
        }

        // --- AHK COMMS ---
        function postToAHK(action, data) {
            try {
                if (window.chrome && window.chrome.webview) {
                    window.chrome.webview.postMessage(JSON.stringify({
                        action: action,
                        data: data || null
                    }));
                }
            } catch (e) {
                console.error('postToAHK ERROR:', e);
            }
        }

        // --- RECEIVERS ---
        window.receiveConfig = function (data) {
            console.log('=== RECEIVE CONFIG CALLED ===');
            console.log('Data received from AHK:', data);
            config = data || {};
            populateForm(config);
        };

        window.receiveAudioDevices = function (list) {
            var sel = document.getElementById('audioDevice');
            sel.innerHTML = "";

            var optD = document.createElement('option');
            optD.value = "Default";
            optD.text = "Default - System Device";
            sel.appendChild(optD);

            if (list && list.length) {
                for (var i = 0; i < list.length; i++) {
                    var opt = document.createElement('option');
                    var devName = list[i];
                    opt.value = devName;
                    opt.text = devName;
                    sel.appendChild(opt);
                }
            }
            if (config.audioDevice) sel.value = config.audioDevice;
        };

        window.receiveDictionary = function (data) {
            dictionary = data || [];
            renderDictionary();
        };

        window.receiveHistoryCount = function (c) {
            document.getElementById('historyCountDisplay').innerText = c + " entries saved";
        };

        window.apiTestResult = function (success) {
            var el = document.getElementById('apiStatusMessage');
            var btn = document.getElementById('btnTestApi');
            btn.innerText = "Test Connection";
            btn.disabled = false;

            if (success) {
                el.className = "status-text status-success";
                el.innerText = "‚úì Connection Successful";
            } else {
                el.className = "status-text status-error";
                el.innerText = "‚úó Connection Failed";
            }
        };

        window.showToast = function (msg, type) {
            var t = document.getElementById('toastMessage');
            t.innerText = msg;
            t.className = "toast show " + (type || "success");
            setTimeout(function () { t.className = "toast"; }, 3000);
        };

        // --- FORM LOGIC ---
        function populateForm(cfg) {
            // API Key
            if (cfg.groqApiKey) {
                document.getElementById('groqApiKey').value = cfg.groqApiKey;
            }

            // Hotkey
            if (cfg.hotkey) {
                var hkText = formatHotkey(cfg.hotkey);
                document.getElementById('hotkeyDisplay').value = hkText;

                // Toggle Logic - only ^LWin is the default
                var isDefault = (cfg.hotkey === '^LWin');
                var defToggle = document.getElementById('hkDefault');
                var custToggle = document.getElementById('hkCustom');
                var custControls = document.getElementById('customHotkeyControls');

                if (isDefault) {
                    if (defToggle) defToggle.checked = true;
                    if (custToggle) custToggle.checked = false;
                    if (custControls) custControls.style.display = "none";
                } else {
                    if (defToggle) defToggle.checked = false;
                    if (custToggle) custToggle.checked = true;
                    if (custControls) custControls.style.display = "block";
                }
            }

            // Convert numeric booleans (0/1) to actual booleans
            // AHK saves booleans as integers, so we need to convert
            const toBool = (val) => {
                if (typeof val === 'number') return val !== 0;
                if (typeof val === 'boolean') return val;
                return !!val;
            };

            // General - Preferences
            document.getElementById('launchAtStartup').checked = toBool(cfg.launchAtStartup);
            document.getElementById('showOverlay').checked = toBool(cfg.showOverlay);
            document.getElementById('playSounds').checked = toBool(cfg.playSounds);
            document.getElementById('stickyMode').checked = toBool(cfg.stickyMode);

            // Audio - Device
            if (cfg.audioDevice) {
                const deviceSelect = document.getElementById('audioDevice');
                deviceSelect.value = cfg.audioDevice;
            }

            // Audio - Quality (radio buttons converted to toggles)
            const qualityValue = cfg.recordingQuality || 'medium';
            document.querySelectorAll('.quality-toggle').forEach(toggle => {
                toggle.checked = (toggle.dataset.quality === qualityValue);
            });

            // Audio - Storage
            document.getElementById('saveAudioRecordings').checked = toBool(cfg.saveAudioRecordings);
            if (cfg.keepLastRecordings) {
                document.getElementById('keepLastRecordings').value = cfg.keepLastRecordings;
            }

            // Advanced - Text Processing
            document.getElementById('enableLLMCleanup').checked = toBool(cfg.enableLLMCleanup);
            document.getElementById('autoRemoveFillers').checked = toBool(cfg.autoRemoveFillers);
            document.getElementById('smartPunctuation').checked = toBool(cfg.smartPunctuation);

            // Advanced - History
            if (cfg.historyRetention) {
                document.getElementById('historyRetention').value = cfg.historyRetention;
            }

            // Advanced - Debug
            document.getElementById('debugLogging').checked = toBool(cfg.debugLogging);

            console.log('=== POPULATE FORM CALLED ===');
            console.log('Config received:', cfg);
            console.log('Config type:', typeof cfg);
            console.log('launchAtStartup value:', cfg.launchAtStartup, 'type:', typeof cfg.launchAtStartup);
            console.log('showOverlay value:', cfg.showOverlay, 'type:', typeof cfg.showOverlay);
        }

        function saveConfig(shouldClose) {
            config.groqApiKey = getVal('groqApiKey');
            config.launchAtStartup = getCheck('launchAtStartup');
            config.showOverlay = getCheck('showOverlay');
            config.playSounds = getCheck('playSounds');
            config.stickyMode = getCheck('stickyMode');

            config.audioDevice = getVal('audioDevice');
            config.saveAudioRecordings = getCheck('saveAudioRecordings');
            config.keepLastRecordings = parseInt(getVal('keepLastRecordings'));

            var qualityToggles = document.querySelectorAll('.quality-toggle');
            for (var i = 0; i < qualityToggles.length; i++) {
                if (qualityToggles[i].checked) {
                    config.recordingQuality = qualityToggles[i].getAttribute('data-quality');
                }
            }

            config.enableLLMCleanup = getCheck('enableLLMCleanup');
            config.autoRemoveFillers = getCheck('autoRemoveFillers');
            config.smartPunctuation = getCheck('smartPunctuation');
            config.historyRetention = parseInt(getVal('historyRetention'));
            config.debugLogging = getCheck('debugLogging');

            // Ensure hotkey is always present (safety net)
            if (!config.hotkey) config.hotkey = "^LWin";

            postToAHK('saveConfig', config);

            var actionText = shouldClose ? 'Saving settings...' : 'Applying settings...';
            showToast(actionText, 'info');

            // Tell AHK to close after save completes (separate message for reliability)
            if (shouldClose) {
                postToAHK('closeAfterSave');
            }
        }

        // Called by AHK after config is successfully saved
        window.receiveConfigSaved = function (success) {
            if (success) {
                showToast('Settings saved successfully!', 'success');
                // AHK handles engine reload and window close directly
            } else {
                showToast('Failed to save settings', 'error');
            }
        };

        function closeSettings() {
            postToAHK('closeSettings');
        }

        // --- DICTIONARY ---
        function renderDictionary() {
            var list = document.getElementById('dictList');
            var term = document.getElementById('dictSearch').value.toLowerCase();
            list.innerHTML = "";

            if (dictionary.length === 0) {
                list.innerHTML = '<div style="text-align:center; padding:48px; color:#999; font-size: 14px;">No dictionary entries yet.<br><br><strong style="color:#FF6B35;">Click "+ Add Entry"</strong> to create your first custom term.</div>';
                return;
            }

            var hasResults = false;
            for (var i = 0; i < dictionary.length; i++) {
                var item = dictionary[i];
                if (term && item.spoken.toLowerCase().indexOf(term) == -1
                    && item.written.toLowerCase().indexOf(term) == -1) continue;

                hasResults = true;
                var row = document.createElement('div');
                row.className = "dict-row";

                var html = '<div class="dict-col-spoken">' + item.spoken + '</div>';
                html += '<div class="dict-col-arrow">‚Üí</div>';
                html += '<div class="dict-col-written">' + item.written + '</div>';
                html += '<div class="dict-col-action"><span class="delete-icon" onclick="deleteDictItem(' + i + ')">‚úï</span></div>';

                row.innerHTML = html;
                list.appendChild(row);
            }

            if (!hasResults) {
                list.innerHTML = '<div style="text-align:center; padding:48px; color:#999; font-size: 14px;">No matches found for "' + term + '"</div>';
            }
        }

        window.deleteDictItem = function (idx) {
            if (confirm("Delete this entry?")) {
                dictionary.splice(idx, 1);
                renderDictionary();
                postToAHK('saveDictionary', dictionary);
            }
        };

        function addDictionaryEntry() {
            var s = getVal('entrySpoken');
            var w = getVal('entryWritten');
            if (!s || !w) { alert("Both fields are required"); return; }

            dictionary.push({ "spoken": s, "written": w });
            renderDictionary();
            postToAHK('saveDictionary', dictionary);
            closeModal('modalAddEntry');
            showToast("Entry added!", "success");
        }



        // Custom Modal Functions
        // Single unified modal system
        function showModal(title, message, buttons) {
            const modal = document.getElementById('customModal');
            const titleEl = document.getElementById('modalTitle');
            const messageEl = document.getElementById('modalMessage');
            const buttonsEl = document.getElementById('modalButtons');

            if (!modal || !titleEl || !messageEl || !buttonsEl) {
                console.error('Modal elements not found');
                return Promise.resolve(false);
            }

            titleEl.textContent = title;
            messageEl.textContent = message;
            buttonsEl.innerHTML = '';

            return new Promise((resolve) => {
                buttons.forEach(btn => {
                    const button = document.createElement('button');
                    button.textContent = btn.text;
                    button.onclick = () => {
                        modal.style.display = 'none';
                        resolve(btn.value);
                    };

                    // Apply styles
                    button.style.cssText = 'min-width: 100px; padding: 12px 24px; font-size: 15px; font-weight: 600; border-radius: 8px; cursor: pointer; font-family: system-ui;';

                    if (btn.primary) {
                        button.style.cssText += 'border: none; background: #FF6B35; color: #ffffff; box-shadow: 0 2px 8px rgba(255, 107, 53, 0.3);';
                    } else {
                        button.style.cssText += 'border: 2px solid #ced4da; background: #ffffff; color: #495057;';
                    }

                    buttonsEl.appendChild(button);
                });

                modal.style.display = 'flex';
            });
        }

        function showConfirm(message, title = 'Confirm Action') {
            return showModal(title, message, [
                { text: 'Cancel', value: false, primary: false },
                { text: 'OK', value: true, primary: true }
            ]);
        }

        function showAlert(message, title = 'QuickSay') {
            return showModal(title, message, [
                { text: 'OK', value: true, primary: true }
            ]);
        }

        // Close modal when clicking outside
        document.addEventListener('click', function (e) {
            const modal = document.getElementById('customModal');
            if (e.target === modal) {
                modal.style.display = 'none';
            }
        });

        // --- HISTORY ---
        async function clearHistory() {
            const confirmed = await showConfirm(
                'This will permanently delete all transcription history.',
                'Clear all history?'
            );

            if (confirmed) {
                console.log('User confirmed - clearing history');

                // Use our global postToAHK helper which wraps proper postMessage
                postToAHK('clearHistory');

                // Show loading state
                var countDisplay = document.getElementById('historyCountDisplay');
                if (countDisplay) {
                    countDisplay.innerText = 'Clearing...';
                }
            } else {
                console.log('User cancelled history clear');
            }
        }

        // Called by AHK after history clear attempt
        // AHK sends Map({success: bool, message: string}) as single data parameter
        window.receiveHistoryClearResult = async function (data) {
            var success = data && data.success;
            var message = data && data.message;
            if (success) {
                await showAlert(message || 'History cleared successfully!', 'Success');
            } else {
                await showAlert(message || 'Failed to clear history.', 'Error');
            }
        };

        // --- HOTKEY ---
        function startHotkeyListen() {
            tempHotkey = "";
            document.getElementById('newHotkeyDisplay').innerText = "Press keys now...";
            document.onkeydown = function (e) {
                e.preventDefault();
                var key = e.key;
                if (key == "Control" || key == "Alt" || key == "Shift" || key == "Meta") return;

                var disp = "";
                var ahk = "";

                // Track modifiers explicitly from event flags (not from key name)
                if (e.ctrlKey) { disp += "Ctrl + "; ahk += "^"; }
                // Only count Shift if user actually pressed Shift, not just because
                // the browser reports an uppercase letter with Ctrl held
                if (e.shiftKey && e.getModifierState("Shift")) { disp += "Shift + "; ahk += "+"; }
                if (e.altKey) { disp += "Alt + "; ahk += "!"; }
                if (e.metaKey) { disp += "Win + "; ahk += "#"; }

                // Normalize the key: use e.code for letter/number keys to avoid
                // Ctrl causing uppercase letters (browser quirk)
                var ahkKey = key;
                if (e.code && e.code.startsWith("Key")) {
                    // e.code = "KeyA" ‚Üí "a", avoids Ctrl making it uppercase
                    ahkKey = e.code.slice(3).toLowerCase();
                } else if (e.code && e.code.startsWith("Digit")) {
                    ahkKey = e.code.slice(5); // "Digit1" ‚Üí "1"
                } else if (key === " ") {
                    ahkKey = "Space";
                } else if (key.length === 1) {
                    ahkKey = key.toLowerCase();
                }
                // Function keys, arrows, etc. keep their original name

                disp += ahkKey.length === 1 ? ahkKey.toUpperCase() : ahkKey;
                ahk += ahkKey;

                document.getElementById('newHotkeyDisplay').innerText = disp;
                tempHotkey = ahk;
            };
        }

        function stopHotkeyListen() {
            document.onkeydown = null;
        }

        function confirmHotkey() {
            if (tempHotkey) {
                config.hotkey = tempHotkey;
                setVal('hotkeyDisplay', formatHotkey(config.hotkey), false);
                showToast("Hotkey updated!", "success");
            }
            stopHotkeyListen();
            closeModal('modalHotkey');
        }

        // --- UTILS ---
        function getVal(id) {
            var el = document.getElementById(id);
            return el ? el.value : "";
        }
        function setVal(id, v, isText) {
            var el = document.getElementById(id);
            if (el) {
                if (isText) el.innerText = v;
                else el.value = v;
            }
        }
        function getCheck(id) {
            var el = document.getElementById(id);
            return el ? el.checked : false;
        }
        function setCheck(id, v) {
            var el = document.getElementById(id);
            if (el) el.checked = !!v;
        }

        function openModal(id) { document.getElementById(id).className = "modal-overlay active"; }
        function closeModal(id) { document.getElementById(id).className = "modal-overlay"; }

        function togglePass() {
            var el = document.getElementById('groqApiKey');
            if (el.type == "password") el.type = "text";
            else el.type = "password";
        }

        function formatHotkey(hk) {
            if (!hk) return "None";
            var s = hk;

            // Replace AHK modifier symbols with readable names
            s = s.replace(/\^/g, "Ctrl + ");
            s = s.replace(/\!/g, "Alt + ");
            s = s.replace(/\+/g, "Shift + ");
            s = s.replace(/\#/g, "Win + ");

            // Replace AHK key names with readable names
            s = s.replace(/LWin/g, "Win");
            s = s.replace(/RWin/g, "Win");
            s = s.replace(/LAlt/g, "Alt");
            s = s.replace(/RAlt/g, "Alt");
            s = s.replace(/LCtrl/g, "Ctrl");
            s = s.replace(/RCtrl/g, "Ctrl");
            s = s.replace(/LShift/g, "Shift");
            s = s.replace(/RShift/g, "Shift");
            s = s.replace(/Space/g, "Space");

            // Clean up double spaces
            s = s.replace(/  +/g, " ");
            // Clean up trailing " + "
            s = s.replace(/\s*\+\s*$/, "");

            return s.trim();
        }

        function testApiConnection() {
            var btn = document.getElementById('btnTestApi');
            btn.disabled = true;
            btn.innerText = "Testing...";
            document.getElementById('apiStatusMessage').innerText = "";
            postToAHK('testGroqAPI', { apiKey: getVal('groqApiKey') });
        }









        // --- HOTKEY TOGGLE LISTENERS ---
        (function () {
            var toggles = document.querySelectorAll('.hotkey-toggle');
            for (var i = 0; i < toggles.length; i++) {
                toggles[i].onclick = function (e) {
                    var val = this.value;
                    var isChecked = this.checked;

                    // Enforce mutual exclusivity
                    var allToggles = document.querySelectorAll('.hotkey-toggle');
                    for (var j = 0; j < allToggles.length; j++) {
                        if (allToggles[j] !== this) allToggles[j].checked = false;
                    }
                    // Enforce at least one checked (if user clicks active one, keep it checked)
                    if (!isChecked) {
                        this.checked = true;
                        return;
                    }

                    var controls = document.getElementById('customHotkeyControls');
                    if (val === 'custom') {
                        controls.style.display = 'block';
                    } else {
                        controls.style.display = 'none';
                        // Set Default
                        config.hotkey = "^LWin";
                        document.getElementById('hotkeyDisplay').value = "Ctrl + Win";
                    }
                };
            }
        })();

        // ==================================================================
        // HISTORY & STATISTICS FUNCTIONS (Light Theme Adapted)
        // ==================================================================

        var historyData = [];
        var statsData = {};

        function loadHistory() {
            console.log("‚ïê‚ïê‚ïê loadHistory() CALLED ‚ïê‚ïê‚ïê");
            console.log("postToAHK function exists?", typeof postToAHK);
            console.log("Calling postToAHK('loadHistoryData')...");
            postToAHK('loadHistoryData');
            console.log("postToAHK call completed");
        }

        // Called from AHK
        window.receiveHistoryData = function (data) {
            console.log("‚ïê‚ïê‚ïê receiveHistoryData() CALLED ‚ïê‚ïê‚ïê");
            console.log("Raw data received:", data);

            try {
                // AHK sends arrays wrapped in {history: [...]} to avoid PostMessage limitations
                const historyArray = data && data.history ? data.history : [];
                console.log("Extracted array length:", historyArray.length);

                historyData = historyArray;

                // Calculate count from actual data (eliminates need for separate getHistoryCount call)
                const count = historyData.length;
                const historyTabCount = document.getElementById('historyTabCount');
                if (historyTabCount) {
                    historyTabCount.innerText = count + " entries";
                }

                console.log("Calling renderHistory with", historyData.length, "items");
                renderHistory(historyData);
                console.log("renderHistory completed");
            } catch (e) {
                console.error("Error in receiveHistoryData:", e);
            }
        };

        function renderHistory(data) {
            console.log("‚ïê‚ïê‚ïê renderHistory() CALLED ‚ïê‚ïê‚ïê");
            var list = document.getElementById('historyList');
            if (!list) return;

            if (!data || data.length === 0) {
                list.innerHTML = '<div style="text-align:center; padding:48px; color:#999; font-size: 14px;">No history yet.<br><br><strong style="color:#FF6B35;">Start dictating</strong> to see your transcription history here.</div>';
                return;
            }

            var html = '';
            var slice = data.slice(0, 50);

            slice.forEach(function (item, idx) {
                var txt = item.cleanedText || item.rawText || "(No text)";
                var app = item.appContext || "Unknown App";

                var time = "Recent";
                if (item.timestamp) {
                    var parts = item.timestamp.split(' ');
                    time = parts.length > 1 ? parts[1] : item.timestamp;
                }

                var wc = item.wordCount ? item.wordCount + 'w' : '';
                var dur = item.duration ? (item.duration / 1000).toFixed(1) + 's' : '';
                var meta = time + ' \u00B7 ' + app;
                var stats = [wc, dur].filter(Boolean).join(' \u00B7 ');

                html += '<div class="dict-row" style="flex-direction: column; align-items: flex-start; cursor: pointer;" onclick="toggleHistoryItem(' + idx + ')">';
                html += '<div style="display: flex; justify-content: space-between; width: 100%;">';
                html += '<span class="sub-text" style="margin: 0;">' + meta + '</span>';
                html += '<span class="sub-text" style="margin: 0;">' + stats + '</span>';
                html += '</div>';
                html += '<div style="font-size: 14px; color: #333; font-weight: 500; line-height: 1.4; margin-top: 4px;">' + escapeHtml(txt) + '</div>';

                html += '<div id="hist-expand-' + idx + '" style="display:none; width: 100%; margin-top:8px; padding-top:8px; border-top:1px dashed #e0e0e0;">';
                html += '<div style="font-size: 12px; text-transform: uppercase; letter-spacing: 0.8px; color: #999; font-weight: 600; margin-bottom: 6px;">Raw Transcript</div>';
                html += '<div style="font-size: 13px; color: #444; background: rgba(248,249,250,0.8); padding: 12px; border-radius: 8px; font-family: Consolas, monospace; border: 1px solid rgba(0,0,0,0.06);">' + escapeHtml(item.rawText || "") + '</div>';
                if (item.audioFile) {
                    html += '<div style="font-size: 12px; color: #FF6B35; font-weight: 500; margin-top: 8px;">üéµ ' + escapeHtml(item.audioFile) + '</div>';
                }
                html += '</div>';

                html += '</div>';
            });

            list.innerHTML = html;
            console.log("History rendered: " + slice.length + " items");
        }
        // Search filter for history
        function searchHistory() {
            var query = document.getElementById('historySearch').value.toLowerCase();

            if (!query) {
                // No search query - show all
                renderHistory(historyData);
                return;
            }

            // Filter history by search query
            var filtered = historyData.filter(function (item) {
                return (item.cleanedText && item.cleanedText.toLowerCase().indexOf(query) !== -1) ||
                    (item.rawText && item.rawText.toLowerCase().indexOf(query) !== -1) ||
                    (item.appContext && item.appContext.toLowerCase().indexOf(query) !== -1);
            });

            console.log('Search query:', query, '- Found', filtered.length, 'results');
            renderHistory(filtered);
        }

        function toggleHistoryItem(idx) {
            var el = document.getElementById('hist-expand-' + idx);
            if (el.style.display === 'none') el.style.display = 'block';
            else el.style.display = 'none';
        }

        function loadStatistics() {
            // Request stats from AHK
            console.log("‚ïê‚ïê‚ïê loadStatistics() CALLED ‚ïê‚ïê‚ïê");
            console.log("Calling postToAHK('loadStatisticsData')...");
            postToAHK('loadStatisticsData');
        }

        // Called from AHK
        window.receiveStatisticsData = function (data) {
            console.log("‚ïê‚ïê‚ïê receiveStatisticsData() CALLED ‚ïê‚ïê‚ïê");
            console.log("Raw stats data received:", data);
            statsData = data || {};
            renderStats(statsData);
            console.log("renderStats completed");
        };

        function renderStats(data) {
            console.log("‚ïê‚ïê‚ïê renderStats() CALLED ‚ïê‚ïê‚ïê");
            if (!data) return;
            console.log("Rendering stats...");

            setText('statTotalWords', data.totalWords ? data.totalWords.toLocaleString() : '0');
            setText('statWPM', data.averageWPM || '0');
            setText('statStreak', data.dailyStreak || '0');

            // Achievements
            var achievements = [
                { icon: 'üéØ', title: 'First Words', desc: 'Dictated your first words', unlocked: data.totalWords > 0 },
                { icon: 'üíØ', title: 'Century', desc: 'Dictated 100 words', unlocked: data.totalWords >= 100 },
                { icon: 'üöÄ', title: 'Power User', desc: 'Dictated 1,000 words', unlocked: data.totalWords >= 1000 },
                { icon: '‚≠ê', title: 'Word Master', desc: 'Dictated 10,000 words', unlocked: data.totalWords >= 10000 },
                { icon: 'üî•', title: 'On Fire', desc: '7-day streak', unlocked: data.dailyStreak >= 7 },
                { icon: 'üí™', title: 'Dedicated', desc: '30-day streak', unlocked: data.dailyStreak >= 30 }
            ];

            var html = '';
            achievements.forEach(function (ach) {
                var opacity = ach.unlocked ? '1' : '0.4';
                var bg = ach.unlocked ? '#ffffff' : 'rgba(248, 249, 250, 0.8)';
                var border = ach.unlocked ? '1px solid rgba(0, 0, 0, 0.06)' : '1px dashed rgba(0, 0, 0, 0.06)';

                html += '<div style="background:' + bg + '; border:' + border + '; border-radius:14px; padding:14px 18px; display:flex; align-items:center; gap:14px; opacity:' + opacity + ';">';
                html += '<div style="font-size:24px;">' + ach.icon + '</div>';
                html += '<div style="flex:1;">';
                html += '<div style="font-weight:500; font-size:14px; color:#333;">' + ach.title + '</div>';
                html += '<div class="sub-text" style="margin-top:2px;">' + ach.desc + '</div>';
                html += '</div>';
                if (ach.unlocked) html += '<div style="color:#FF6B35;">‚úì</div>';
                html += '</div>';
            });

            document.getElementById('achievementsList').innerHTML = html;
        }

        function escapeHtml(text) {
            if (!text) return "";
            return text
                .replace(/&/g, "&amp;")
                .replace(/</g, "&lt;")
                .replace(/>/g, "&gt;")
                .replace(/"/g, "&quot;")
                .replace(/'/g, "&#039;");
        }

        function setText(id, txt) {
            var el = document.getElementById(id);
            if (el) el.innerText = txt;
        }

        // Ctrl+S keyboard shortcut to save
        document.addEventListener('keydown', function(e) {
            if (e.ctrlKey && e.key === 's') {
                e.preventDefault();
                saveConfig(true);
            }
        });







    </script>
</body>

</html>